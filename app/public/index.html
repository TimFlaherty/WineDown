<!DOCTYPE html>
<html>
<head>
	<title>WineDown</title> 
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
	<link rel="stylesheet" href="lib/winedown.css" />
	<link rel="stylesheet" href="lib/modal.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
	<!-- AJAX call checks cookies to see if user is logged in -->
	<script>
        //Check if user is logged in and load appropriate button
		function logcheck(){
			$.ajax({url: '/logcheck', 
				type: 'get'
			}).done(function (data) {
                if (data == true) {
                    $("#login").html('<button class="btn btn-outline-light my-2 my-sm-0" onclick="logout()">Log Out</button>');
                } else if (data == false){
                    var btn = "document.getElementById('id01').style.display='block'";
                    $("#login").html('<button class="btn btn-outline-light my-2 my-sm-0" onclick="'+btn+'">Login</button>');
                }
			});
		}
			
		logcheck();
		
	</script>
	<!-- Pre-load a loading GIF for AJAX calls but do not display --> 
	<img src="lib/loading.gif" alt="Please wait..." style="display:none;">
	
    <nav class="navbar navbar-expand-md navbar-dark static-top">
        <a class="navbar-brand" href="#">WineDown</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        	<span class="navbar-toggler-icon"></span>
      	</button>
      	<div class="collapse navbar-collapse" id="navbarsExampleDefault">
      		<ul class="navbar-nav mr-auto">
      			<li class="nav-item">
            		<a class="nav-link" href="#">Learn</a>
          		</li>
				<li class="nav-item">
            		<a class="nav-link" href="#">Tasting Notes</a>
          		</li>
          		<li class="nav-item">
            		<a class="nav-link" href="#">Help</a>
          		</li>
			</ul>
			<div id="login"></div>
		</div>
    </nav>
    
    <div id="maptainer" class="container-fluid">
    	<div id="pagerow" class="row">
			<div class="left col-lg-auto">
                <div class="row">
                    <div class="col-lg-auto">
                        <select id="opts"></select>
                    </div>
                    <div class="col-lg-auto">
                        <button class="btn btn-outline-success" onclick="filter()">Filter by Varietal</button>
                    </div>
                </div>
			</div>
			<div id="map" class="col-12 col-lg-auto"></div>
			<div class="right col">Ads?</div>
        </div>
    </div>
	
	<!-- Footer and "Filter by Varietal Drop up" -->
    <nav class="navbar navbar-expand-md navbar-dark fixed-bottom">
		<div id= "varietal_dropup"class="dropup">
			<button class="varietalchoioces btn btn-default dropdown-toggle" type="button" id="menu1" data-toggle="dropdown">Filter By Varietal
			<span class="caret"></span></button>
			<ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
				<!-- There might be a better way to style these list elements with black text but I couldn't get class to work here-->
				<li role="presentation"><a style="color:black" role="menuitem" tabindex="-1" href="#">Cabrenet Sauvignon</a></li>
				<li role="presentation"><a style="color:black" role="menuitem" tabindex="-1" href="#">Chardonnay</a></li>
				<li role="presentation"><a style="color:black" role="menuitem" tabindex="-1" href="#">Petit Syrah</a></li>
				<li role="presentation"><a style="color:black" role="menuitem" tabindex="-1" href="#">Sauvignon Blanc</a></li>
				<li role="presentation"><a style="color:black" role="menuitem" tabindex="-1" href="#">White Blend</a></li>
				<li role="presentation"><a style="color:black" role="menuitem" tabindex="-1" href="#">Zinfandel</a></li>
			</ul>
		</div>
    </nav>
    
    <!-- Modal Sign In Box, hidden by default -->
    <div id="id01" class="modal">
		<div class="modal-content animate">
			<div class="modtainer">
				<label><b>Username</b></label>
				<input type="text" placeholder="Enter Username" id="uname" required>
				
				<label><b>Password</b></label>
				<input type="password" placeholder="Enter Password" id="pwd" required>
				<div id="addfield"></div>
				<br>
				<div id="modbutton"><button onclick="login()">Login</button></div>
			</div>
			<div id="resultmsg"></div>
			<div class="modtainer" style="background-color:#f1f1f1">
				<button type="button" onclick="modclose()" class="cancelbtn">Cancel</button>
				<button type="button" onclick="create()" class="signup">Create Account</button>
				<!--<span class="psw"><a href="#">Forgot password?</a></span>-->
			</div>
		</div>
	</div>

	<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyBHxLxifPq-0zZ9bnZXQjjfPcmtawXwhJg"></script>
	<script src="http://labs.easyblog.it/maps/leaflet-search/dist/leaflet-search.min.js"></script>
	<script>		
		// Declare OpenStreetMap tiles
		const osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			id: 'OpenStreetMap.Mapnik',
			//attribution: 'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
		});

		// Declare map variable
		var map;
		
		var markers = new L.FeatureGroup();
		
		//Declare mapping function
		function mapit() {
			// Initialize map and center on Amador County (roughly)
			map = L.map('map', {
				center: [38.4, -120.8], 
				zoom: 11,
				layers: [osm]
			});
			
			osm.addTo(map);
	
			// LOCATION
			function locate() {
				// Find user location
				map.locate({setView: true, maxZoom: 12});
				
				//Declare function to add pin at user location
				function onLocationFound(e) {
					L.marker(e.latlng).addTo(map)
					.bindPopup("You are here");
				}
				
				// Add location pin to map
				map.on('locationfound', onLocationFound);
			}
			
			//locate();
			
			
			
			// MAP SEARCH FUNCTIONALITY
			// Initialize Google maps geocoder
			var geocoder = new google.maps.Geocoder();
			
			// API call to geocoder
			function googleGeocoding(text, callResponse)
			{
				geocoder.geocode({address: text}, callResponse);
			}
			
			// Format API response
			function formatJSON(rawjson)
			{
				var json = {},
					key, loc, disp = [];
		
				for(var i in rawjson)
				{
					key = rawjson[i].formatted_address;
					loc = L.latLng( rawjson[i].geometry.location.lat(), rawjson[i].geometry.location.lng() );
					json[ key ]= loc;	//key,value format
				}
		
				return json;
			}
			
			// Add search control to map
			map.addControl( new L.Control.Search({
					sourceData: googleGeocoding,
					formatData: formatJSON,
					markerLocation: true,
					autoType: false,
					autoCollapse: true,
					minLength: 2
				}) 
			);
		}
		
		//Call map function
		mapit();
		
		// WINERY PINS
		// AJAX request to node server returns an array of winery data 
		function pins(x) {
			markers.clearLayers();
			$.ajax({url: '/winerypins?varietal='+x, 
				type: 'get',
				}).done(function (data) {
				for (i=0;i<data.length;i++) {
					//If there is no winery rating available, display message
					var rating = data[i].wineryrating;
					if (rating == null) {
						rating = "Be the first to review!";
					}
					//If there is no varietal information available, display message
					var varietals = data[i].varietals;
					if (varietals == null) {
						varietals = "Be the first to review!";
					}
					// For each winery i, grab coordinates, drop a marker, and populate the marker data
					var marker = L.marker([data[i].lat, data[i].lng])
						.bindPopup("<a href='winery?wineryid="+data[i].wineryid+"'><h3>"+data[i].wineryname+"</h3></a>"
						+ "<b>Tasting Room Hours:</b><br>" 
						+ data[i].hours
						+ "<br><br><b>Varietals:</b><br>"
						+ varietals
						+ "<br><br><b>WineDown Rating: </b><br>"
						+ rating
					);
					
					markers.addLayer(marker);
					map.addLayer(markers);
				};
			});
		}
		
		pins('all');
		
		function selector() {
			$.ajax({url: '/opts', 
				type: 'get',
				}).done(function (data) {
				for (i=0;i<data.length;i++) {
					$('#opts').append($('<option>', {
						value: data[i].varietal,
						text: data[i].varietal
					}));
				};
			});
		}
		
		selector();
			
		function filter() {
			pins($('#opts').val());
		}
		
		//User login function
		function login(){
			$("#resultmsg").html('<img src="lib/loading.gif" alt="Please wait...">');
			var name = $("#uname").val();
			var pass = $("#pwd").val();
			$.ajax({url: '/login', 
				type: 'post',
				data: {
					uname: name,
					pwd: pass
				}
			}).done(function (data) {
				if(data == true) {
					$("#login").html('<button class="btn btn-outline-danger my-2 my-sm-0" onclick="logout()">Log Out</button>');
					modclose();
				} else {
					$("#resultmsg").html(data);
				}
			});
		}
		
		//User logout function
		function logout(){
			$.ajax({url: '/logout', 
				type: 'get'
			}).done(function (data) {
				var btn = "document.getElementById('id01').style.display='block'";
				$("#login").html('<button class="btn btn-outline-light my-2 my-sm-0" onclick="'+btn+'" style="width:auto;">Login</button>');
			});
		}
        
        
		//User signup function
		function signup(){
			$("#resultmsg").html('<img src="lib/loading.gif" alt="Please wait...">');
			var name = $("#uname").val();
			var pass = $("#pwd").val();
			var mail = $("#email").val();
			$.ajax({url: '/signup', 
				type: 'post',
				data: {
					uname: name,
					pwd: pass,
					email: mail
				}
			}).done(function (data) {
				if(data == true) {
					$("#login").html('<button class="btn btn-outline-light my-2 my-sm-0" style="width:auto;" onclick="logout()">Log Out</button>');
					window.alert('Welcome to WineDown!');
					logcheck();
					modclose();
				} else {
					$("#resultmsg").html(data);
				}
			});
		}
        
		
        // Get the modal
		var modal = document.getElementById('id01');
		
		// When the user clicks anywhere outside of the modal, close it
		window.onclick = function(event) {
			if (event.target == modal) {
				modal.style.display = "none";
			}
		}
		
		function modclose() {
			$('#id01').css('display','none');
			$('#resultmsg').html('');
			$('#addfield').html('');
			$('#modbutton').html('<button onclick="login()">Log In</button>');
		}
        
		//Displays user signup dialog in modal box
		function create() {
			$("#resultmsg").html('');
			$("#addfield").html('<label><b>Email</b></label>'
			+'<input type="text" placeholder="Enter Email" id="email" required>');
			
			$("#modbutton").html('<button onclick="signup()">Sign Up</button>');
		}	
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
</body>
</html>
