<!DOCTYPE html>
<html>
<head>
	<title><%=wineryname%> on WineDown</title> 
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="icon" type="image/ico" href="images/favicon.ico">
    <link rel="stylesheet" href="lib/winery.css" />
    <link rel="stylesheet" href="lib/winedown.css" />
</head>

<body>
	<!-- AJAX call checks cookies to see if user is logged in -->
	<script>
        //Check if user is logged in and load appropriate button
		function logcheck(){
			$.ajax({url: '/logcheck', 
				type: 'get'
			}).done(function (data) {
                if (data == false) {
					var btn = "document.getElementById('id01').style.display='block'";
					$("#login").html('<button class="btn btn-outline-light my-2 my-sm-0" data-toggle="modal" data-target="#logmod">Login</button>');
                    $("#rating").hide();
                    $("#reviewbtn").html('<button class="btn btn-outline-success my-2 my-sm-0" data-toggle="modal" data-target="#logmod">Login to Review</button>');
                } else if (data == true){
                    $("#login").html('<button class="btn btn-outline-light my-2 my-sm-0" onclick="logout()">Log Out</button>');
                    $("#rating").show();
                    $("#reviewbtn").html('<button class="btn btn-outline-success my-2 my-sm-0" onclick="winereview()">Rate It!</button>');
                }
			});
		}
			
		logcheck();
        
	</script>
    
	<!-- Pre-load a loading GIF for AJAX calls but do not display --> 
	<img src="lib/loading.gif" alt="Please wait..." style="display:none;">
	
    <nav class="navbar navbar-expand-md navbar-dark static-top">
        <a class="navbar-brand" href="/"><img src="images/logo.png" alt="Winedown" height="40"></a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        	<span class="navbar-toggler-icon"></span>
      	</button>
      	<div class="collapse navbar-collapse" id="navbarsExampleDefault">
      		<ul class="navbar-nav mr-auto">
      			<li class="nav-item">
            		<a class="nav-link" href="learn_more.html">Learn</a>
          		</li>
				<li class="nav-item">
            		<a class="nav-link" href="tasting_notes.html">Tasting Notes</a>
          		</li>
          		<li class="nav-item">
            		<a class="nav-link" href="#">Help</a>
          		</li>
			</ul>
			<div id="login"></div>
		</div>
    </nav>
    
	<div class="container-fluid">
		<div class="mainrow row">
			<div id="info" class="col-xl-2 col-lg-3">
				<h2><%=wineryname%></h2>
				<%=address%>
				<br>
				<%=hours%>
				<br>
				<%=phone%>
				<br>
				<a href="<%=url%>">Visit Website</a>
				<br>
				<br>
				<div id="rating">
					<select id="ratenum">
						<option selected="selected" disabled>Select your rating...</option>
						<option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
					</select>
					<br>
					<textarea id="narrative" placeholder="Leave a few words about <%=wineryname%>"></textarea>
					<br>
				</div>
				<div id="reviewbtn"></div>
			</div>
			<div class="col-xl-5 col-lg-4">
				<div id="accord" data-children=".scrolly">
					<hr>
					<h3 data-toggle="collapse" data-parent="#accord" href="#rvwtarget" aria-expanded="true" aria-controls="rvwtarget">Reviews of <%=wineryname%></h3>
					<hr>
					<div id="rvwtarget" class="scrolly collapse show">
						
					</div>
				</div>
			</div>
			<div class="col-xl-5 col-lg-5">
			<div id="accord2" data-children=".scrolly">
				<hr>
				<h3 data-toggle="collapse" data-parent="#accord2" href="#winetarget" aria-expanded="true" aria-controls="winetarget"><%=wineryname%> Wines</h3>
				<hr>
				<div id="winetarget" class="scrolly collapse show">
					<div class="row">
						<div class="wine col-5"><b>Name</b></div>
						<div class="vintage col-2"><b>Vintage</b></div>
						<div class="varietal col-3"><b>Varietal</b></div>
						<div class="winerating col-2"><b>Rating</b></div>
					</div>
					<br>
				</div>
			</div>
			</div>
		</div>
	</div>
	
	<!-- Footer -->
    <nav class="navbar navbar-expand-md navbar-dark fixed-bottom justify-content-center">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#footbtn" aria-controls="footbtn" aria-expanded="false" aria-label="Toggle footer">
        	More
      	</button>
      	<div class="collapse navbar-collapse" id="footbtn">
      		<ul class="navbar-nav">
      			<li class="nav-item">
            		<a class="nav-link" href="learn_more.html">Suggestions?</a>
          		</li>
				<li class="nav-item">
            		<a class="nav-link" href="tasting_notes.html">About</a>
          		</li>
          		<li class="nav-item">
            		<a class="nav-link" href="#">Contact</a>
          		</li>
			</ul>
		</div>
    </nav>
    
    <!-- New Bootstrap Modal -->
	<div class="modal fade" id="logmod" tabindex="-1" role="dialog" aria-labelledby="logmod" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="logmod">Login</h5>
					<button type="button" class="close" data-dismiss="modal" onclick="modclose()">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				
				<div class="modal-body">
					<h6>Username</h6>
					<input type="text" class="form-control" placeholder="Enter Username" id="uname" required>
					<br>
					<h6>Password</h6>
					<input type="password" class="form-control" placeholder="Enter Password" id="pwd" required>
					<div id="addfield"></div>
					<br>
					<div id="resultmsg" class="text-center"></div>
				</div>
				
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" onclick="create()">Create Account</button>
					<div id="modbutton"><button type="button" class="btn btn-light" onclick="login()">Login</button></div>
				</div>
			</div>
	  	</div>
	</div>
    
    <script>
    /* USER REVIEW FUNCTIONS */
        //New winery review
        function wineryreview(){
            $("#reviewbtn").html('<img src="lib/loading.gif" alt="Please wait...">');
			var ratenum = $("#ratenum").val();
			var narr = $("#narrative").val();
			$.ajax({url: '/review', 
				type: 'post',
				data: {
                    wineid: 'none',
                    wineryid: '<%=wineryid%>',
					rating: ratenum,
					narrative: narr
				}
			}).done(function (data) {
				if(data == true) {
					$("#reviewbtn").html('COOL');
				} else {
					$("#reviewbtn").html(data);
				}
			});
			wineryrvws();
        }
        
        //Display winery reviews
        function wineryrvws() {
			$.ajax({url: '/wineryrvw?wineryid=<%=wineryid%>', 
				type: 'get',
				}).done(function (data) {
				if(data.length==0) {
					$('#rvwtarget').html('Be the first to review!');
					$('#rvwtarget').css('height', '100px');
				} else {
					for (i=0;i<data.length;i++) {
						var rating = data[i].rating;
						if (rating == null) {
							rating = 'N/A';
						};
						$('#rvwtarget').append('<div class="rvwrow"><div class="row">'
							+'<div class="rating col-4"><h5><b>Rating: </b>'
							+rating+'</h5></div>'
                            +'<div class="uname col-4"><a href="user?uname='+data[i].uname+'">'
							+data[i].uname+'</a></div><div class="rvwdate col-4">'
                            +data[i].rvwdate+'</div></div><div class="narrative row col">'
							+data[i].narrative+'</div></div>'
						);
					};
				};
			});
		}
		
		wineryrvws();
    
    /* DISPLAY WINES */
    	function wines() {
			$.ajax({url: '/wines?wineryid=<%=wineryid%>', 
				type: 'get',
				}).done(function (data) {
				for (i=0;i<data.length;i++) {
					var rating = data[i].winerating;
					if (rating == null) {
						rating = 'N/A';
					};
                    var vintage = data[i].vintage;
					if (vintage == 0) {
						vintage = 'NV';
					};
                    var winename = data[i].winename;
					if (winename == 'NULL') {
						winename = vintage +' '+data[i].varietal;
					};
					$('#winetarget').append('<div class="winerow row">'
						+'<div class="wine col-5"><a href="wine?wineid='+data[i].wineid+'">'
						+winename+'</a></div><div class="vintage col-2">'
						+vintage+'</div><div class="varietal col-3">'
						+data[i].varietal+'</div><div class="winerating col-2">'
						+rating+'</div></div>'
					);
				};
			});
		}
		
		wines();
    
    /* LOGIN-LOGOUT-SIGNUP FUNCTIONS */
        //User login function
		function login(){
			$("#resultmsg").html('<img src="lib/loading.gif" alt="Please wait...">');
			var name = $("#uname").val();
			var pass = $("#pwd").val();
			$.ajax({url: '/login', 
				type: 'post',
				data: {
					uname: name,
					pwd: pass
				}
			}).done(function (data) {
				if(data == true) {
					$("#login").html('<button class="btn btn-outline-danger my-2 my-sm-0" onclick="logout()">Log Out</button>');
					modclose();
				} else {
					$("#resultmsg").html(data);
				}
			});
		}
		
		//User logout function
		function logout(){
			$.ajax({url: '/logout', 
				type: 'get'
			}).done(function (data) {
				logcheck();
			});
		}
        
		//User signup function
		function signup(){
			$("#resultmsg").html('<img src="lib/loading.gif" alt="Please wait...">');
			var name = $("#uname").val();
			var pass = $("#pwd").val();
			var mail = $("#email").val();
			$.ajax({url: '/signup', 
				type: 'post',
				data: {
					uname: name,
					pwd: pass,
					email: mail
				}
			}).done(function (data) {
				if(data == true) {
					$("#login").html('<button class="btn btn-outline-light my-2 my-sm-0" style="width:auto;" onclick="logout()">Log Out</button>');
					window.alert('Welcome to WineDown!');
					logcheck();
					modclose();
				} else {
					$("#resultmsg").html(data);
				}
			});
		}
    
        
    /* MODAL BOX */
        function modclose() {
			$('#logmod').modal('hide');
			$('#resultmsg').html('');
			$('#addfield').html('');
			$("#modbutton").html('<button type="button" class="btn btn-light" onclick="login()">Login</button>');
		}
        
		//Displays user signup dialog in modal box
		function create() {
			$("#resultmsg").html('');
			$("#addfield").html('<br><h6>Email</h6><input type="text" class="form-control" placeholder="Enter Email" id="email" required>');
			$("#modbutton").html('<button class="btn btn-light" onclick="signup()">Sign Up</button>');
		}	
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
</body>
</html>