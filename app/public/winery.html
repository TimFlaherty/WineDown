<!DOCTYPE html>
<html>
<head>
	<title><%=wineryname%> on WineDown</title> 
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="lib/winery.css" />
    <link rel="stylesheet" href="lib/winedown.css" />
    <link rel="stylesheet" href="lib/modal.css" />
</head>

<body>
	<!-- AJAX call checks cookies to see if user is logged in -->
	<script>
        //Check if user is logged in and load appropriate button
		function logcheck(){
			$.ajax({url: '/logcheck', 
				type: 'get'
			}).done(function (data) {
                if (data == false) {
					var btn = "document.getElementById('id01').style.display='block'";
                    $("#login").html('<button onclick="'+btn+'" style="width:auto;">Login</button>');
                    $("#rating").hide();
                    $("#reviewbtn").html('<button onclick="'+btn+'" style="width:100px;">Login to Review</button>');
                } else if (data == true){
                    $("#login").html('<button style="width:auto;" onclick="logout()">Log Out</button>');
                    $("#rating").show();
                    $("#reviewbtn").html('<button onclick="wineryreview()" style="width:100px;">Rate It!</button>');
                }
			});
		}
			
		logcheck();
        
	</script>
    
	<!-- Pre-load a loading GIF for AJAX calls but do not display --> 
	<img src="lib/loading.gif" alt="Please wait..." style="display:none;">
	
    <div id="navi">
        <div id="logo" class="navitem">WD</div>
        <div id="learn" class="navitem">Learn</div>
        <div id="tasting" class="navitem">Tasting Notes</div>
        <div id="help" class="navitem">Help</div>
        <div id="login" class="navitem"></div>
    </div>

	<a href="<%=url%>"><%=wineryname%></a>
	<br>
	<%=address%>
	<br>
	<%=hours%>
	<br>
	<%=phone%>
	<br>
    <br>
    <div id="rating">
        <select id="ratenum">
            <option selected="selected" disabled>Select your rating...</option>
            <option value="1">1</option>
            <option value="1">2</option>
            <option value="1">3</option>
            <option value="1">4</option>
            <option value="1">5</option>
        </select>
        <br>
        <textarea id="narrative" placeholder="Leave a few words about <%=wineryname%>"></textarea>
        <br>
    </div>
    <div id="reviewbtn"></div>
	<br><br>
	<a href="/">Return to Map</a>
    
    <!-- Modal Sign In Box, hidden by default -->
    <div id="id01" class="modal">
		<div class="modal-content animate">
			<div class="modtainer">
				<label><b>Username</b></label>
				<input type="text" placeholder="Enter Username" id="uname" required>
				
				<label><b>Password</b></label>
				<input type="password" placeholder="Enter Password" id="pwd" required>
				<div id="addfield"></div>
				<br>
				<div id="modbutton"><button onclick="login()">Login</button></div>
			</div>
			<div id="resultmsg"></div>
			<div class="modtainer" style="background-color:#f1f1f1">
				<button type="button" onclick="modclose()" class="cancelbtn">Cancel</button>
				<button type="button" onclick="create()" class="signup">Create Account</button>
				<!--<span class="psw"><a href="#">Forgot password?</a></span>-->
			</div>
		</div>
	</div>
    
    <script>
    /* USER REVIEW FUNCTIONS */
        //
        function wineryreview(){
            $("#reviewbtn").html('<img src="lib/loading.gif" alt="Please wait...">');
			var ratenum = $("#ratenum").val();
			var narr = $("#narrative").val();
			$.ajax({url: '/review', 
				type: 'post',
				data: {
                    wineid: 'none',
                    wineryid: <%=wineryid%>,
					rating: ratenum,
					narrative: narr
				}
			}).done(function (data) {
				if(data == true) {
					$("#reviewbtn").html('COOL');
				} else {
					$("#reviewbtn").html(data);
				}
			});
        }
        
    
    /* LOGIN-LOGOUT-SIGNUP FUNCTIONS */
        //User login function
		function login(){
			$("#resultmsg").html('<img src="lib/loading.gif" alt="Please wait...">');
			var name = $("#uname").val();
			var pass = $("#pwd").val();
			$.ajax({url: '/login', 
				type: 'post',
				data: {
					uname: name,
					pwd: pass
				}
			}).done(function (data) {
				if(data == true) {
					modclose();
                    logcheck();
				} else {
					$("#resultmsg").html(data);
				}
			});
		}
		
		//User logout function
		function logout(){
			$.ajax({url: '/logout', 
				type: 'get'
			}).done(function (data) {
				logcheck();
			});
		}
        
        
		//User signup function
		function signup(){
			$("#resultmsg").html('<img src="lib/loading.gif" alt="Please wait...">');
			var name = $("#uname").val();
			var pass = $("#pwd").val();
			var mail = $("#email").val();
			$.ajax({url: '/signup', 
				type: 'post',
				data: {
					uname: name,
					pwd: pass,
					email: mail
				}
			}).done(function (data) {
				if(data == true) {
					window.alert('Welcome to WineDown!');
					logcheck();
					modclose();
				} else {
					$("#resultmsg").html(data);
				}
			});
		}
    
        
    /* MODAL BOX */
        // Get the modal
		var modal = document.getElementById('id01');
		
		// When the user clicks anywhere outside of the modal, close it
		window.onclick = function(event) {
			if (event.target == modal) {
				modal.style.display = "none";
			}
		}
		
		function modclose() {
			$('#id01').css('display','none');
			$('#resultmsg').html('');
			$('#addfield').html('');
			$('#modbutton').html('<button onclick="login()">Log In</button>');
		}
        
		//Displays user signup dialog in modal box
		function create() {
			$("#resultmsg").html('');
			$("#addfield").html('<label><b>Email</b></label>'
			+'<input type="text" placeholder="Enter Email" id="email" required>');
			
			$("#modbutton").html('<button onclick="signup()">Sign Up</button>');
		}	
	</script>
</body>
</html>